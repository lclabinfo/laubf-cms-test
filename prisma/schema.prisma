// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../lib/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// 1. Tenant & Auth Layer
// ============================================================

model Church {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  slug          String   @unique
  customDomain  String?  @unique

  // Branding
  logoUrl       String?
  faviconUrl    String?
  accentColor   String?  @default("#000000")

  // Contact info
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String   @default("US")

  // Social links
  websiteUrl    String?
  facebookUrl   String?
  instagramUrl  String?
  youtubeUrl    String?
  twitterUrl    String?

  // Operational
  timezone      String   @default("America/Los_Angeles")
  locale        String   @default("en-US")
  currency      String   @default("USD")
  status        ChurchStatus @default(ACTIVE)
  plan          PlanTier  @default(STARTER)

  // Metadata
  settings      Json?    @db.JsonB
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  members            ChurchMember[]
  subscription       Subscription?
  customDomains      CustomDomain[]
  speakers           Speaker[]
  serieses           Series[]
  ministries         Ministry[]
  campuses           Campus[]
  messages           Message[]
  events             Event[]
  bibleStudies       BibleStudy[]
  videos             Video[]
  dailyBreads        DailyBread[]
  mediaAssets        MediaAsset[]
  tags               Tag[]
  announcements      Announcement[]
  contactSubmissions ContactSubmission[]
  pages              Page[]
  pageSections       PageSection[]
  menus              Menu[]
  siteSettings       SiteSettings?
  themeCustomization ThemeCustomization?
  apiKeys            ApiKey[]
  auditLogs          AuditLog[]

  // People & Member Management
  people                 Person[]
  households             Household[]
  personGroups           PersonGroup[]
  customFieldDefinitions CustomFieldDefinition[]
  personNotes            PersonNote[]
  personRoleDefinitions  PersonRoleDefinition[]

  @@index([slug])
  @@index([status])
}

enum ChurchStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum PlanTier {
  FREE
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique
  passwordHash    String?
  firstName       String
  lastName        String
  avatarUrl       String?
  emailVerified   Boolean  @default(false)
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  memberships     ChurchMember[]
  sessions        Session[]
  accounts        Account[]
  personNotes     PersonNote[]

  @@index([email])
}

model Account {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model ChurchMember {
  id        String     @id @default(uuid()) @db.Uuid
  churchId  String     @db.Uuid
  userId    String     @db.Uuid
  role      MemberRole @default(EDITOR)
  invitedAt DateTime?
  joinedAt  DateTime   @default(now())

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  church    Church     @relation(fields: [churchId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([churchId, userId])
  @@index([churchId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?

  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  churchId             String    @unique @db.Uuid
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  plan                 PlanTier
  status               SubStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  church               Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([status])
}

enum SubStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

model CustomDomain {
  id                String       @id @default(uuid()) @db.Uuid
  churchId          String       @db.Uuid
  domain            String       @unique
  status            DomainStatus @default(PENDING)
  verificationToken String?
  sslStatus         SslStatus    @default(PENDING)
  verifiedAt        DateTime?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  church            Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([domain])
}

enum DomainStatus {
  PENDING
  VERIFIED
  FAILED
}

enum SslStatus {
  PENDING
  ACTIVE
  ERROR
}

model ApiKey {
  id          String    @id @default(uuid()) @db.Uuid
  churchId    String    @db.Uuid
  name        String
  keyHash     String    @unique
  keyPrefix   String
  permissions String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?

  createdAt   DateTime  @default(now())

  church      Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([keyHash])
}

// ============================================================
// 2. Shared Reference Tables
// ============================================================

model Speaker {
  id        String   @id @default(uuid()) @db.Uuid
  churchId  String   @db.Uuid
  name      String
  slug      String
  title     String?
  bio       String?  @db.Text
  photoUrl  String?
  email     String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  church       Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  messages     Message[]
  bibleStudies BibleStudy[]

  @@unique([churchId, slug])
  @@index([churchId, isActive])
  @@index([churchId, name])
}

model Series {
  id          String    @id @default(uuid()) @db.Uuid
  churchId    String    @db.Uuid
  name        String
  slug        String
  description String?   @db.Text
  imageUrl    String?
  startDate   DateTime?
  endDate     DateTime?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  church        Church          @relation(fields: [churchId], references: [id], onDelete: Cascade)
  messageSeries MessageSeries[]
  bibleStudies  BibleStudy[]

  @@unique([churchId, slug])
  @@index([churchId, isActive])
  @@index([churchId, name])
}

model Ministry {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  name        String
  slug        String
  description String?  @db.Text
  imageUrl    String?
  color       String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  events      Event[]

  @@unique([churchId, slug])
  @@index([churchId, isActive])
}

model Campus {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  name        String
  slug        String
  shortName   String?
  description String?  @db.Text
  imageUrl    String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  events      Event[]

  @@unique([churchId, slug])
  @@index([churchId, isActive])
}

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  churchId  String   @db.Uuid
  name      String
  slug      String
  color     String?

  createdAt DateTime @default(now())

  church      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  contentTags ContentTag[]

  @@unique([churchId, slug])
  @@index([churchId])
}

model ContentTag {
  id         String @id @default(uuid()) @db.Uuid
  tagId      String @db.Uuid
  entityType String
  entityId   String @db.Uuid

  tag        Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, entityType, entityId])
  @@index([entityType, entityId])
  @@index([tagId])
}

// ============================================================
// 3. CMS Content Tables
// ============================================================

model Message {
  id               String        @id @default(uuid()) @db.Uuid
  churchId         String        @db.Uuid
  slug             String
  title            String
  passage          String?
  bibleVersion     String?       @default("ESV")
  speakerId        String?       @db.Uuid
  dateFor          DateTime      @db.Date
  description      String?       @db.Text

  // Video
  videoUrl         String?
  videoDescription String?       @db.Text
  youtubeId        String?
  thumbnailUrl     String?
  duration         String?

  // Audio
  audioUrl         String?

  // Transcripts
  rawTranscript    String?       @db.Text
  liveTranscript   String?       @db.Text
  transcriptSegments Json?       @db.JsonB
  studySections    Json?         @db.JsonB
  attachments      Json?         @db.JsonB

  // Availability flags
  hasVideo         Boolean       @default(false)
  hasStudy         Boolean       @default(false)

  // Publishing
  status           ContentStatus @default(DRAFT)
  publishedAt      DateTime?

  // Relationship to Bible Study
  relatedStudyId   String?       @unique @db.Uuid

  // Metadata
  viewCount        Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  createdBy        String?       @db.Uuid
  updatedBy        String?       @db.Uuid
  deletedAt        DateTime?

  // Relations
  church           Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)
  speaker          Speaker?      @relation(fields: [speakerId], references: [id], onDelete: SetNull)
  messageSeries    MessageSeries[]
  relatedStudy     BibleStudy?   @relation("MessageStudy", fields: [relatedStudyId], references: [id], onDelete: SetNull)

  // Search
  searchVector     Unsupported("tsvector")?

  @@unique([churchId, slug])
  @@index([churchId, dateFor(sort: Desc)])
  @@index([churchId, speakerId])
  @@index([churchId, status])
  @@index([churchId, status, dateFor(sort: Desc)])
  @@index([churchId, hasVideo])
}

model MessageSeries {
  id        String  @id @default(uuid()) @db.Uuid
  messageId String  @db.Uuid
  seriesId  String  @db.Uuid
  sortOrder Int     @default(0)

  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  series    Series  @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([messageId, seriesId])
  @@index([seriesId])
  @@index([messageId])
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

model Event {
  id                 String        @id @default(uuid()) @db.Uuid
  churchId           String        @db.Uuid
  slug               String
  title              String
  type               EventType

  // Scheduling
  dateStart          DateTime      @db.Date
  dateEnd            DateTime?     @db.Date
  startTime          String?
  endTime            String?
  allDay             Boolean       @default(false)

  // Location
  locationType       LocationType  @default(IN_PERSON)
  location           String?
  address            String?
  latitude           Decimal?      @db.Decimal(10, 8)
  longitude          Decimal?      @db.Decimal(11, 8)
  meetingUrl         String?

  // Content
  shortDescription   String?       @db.Text
  description        String?       @db.Text
  welcomeMessage     String?       @db.Text
  coverImage         String?
  imageAlt           String?
  imagePosition      String?

  // Contacts
  contacts           String[]

  // Categorization
  ministryId         String?       @db.Uuid
  campusId           String?       @db.Uuid
  badge              String?

  // Registration
  registrationUrl    String?
  capacity           Int?
  registrationCount  Int           @default(0)

  // Links
  links              Json?         @db.JsonB

  // Flags
  isFeatured         Boolean       @default(false)
  isPinned           Boolean       @default(false)
  isRecurring        Boolean       @default(false)

  // Recurrence
  recurrence         Recurrence    @default(NONE)
  recurrenceDays     String[]
  recurrenceEndType  RecurrenceEndType @default(NEVER)
  recurrenceEndDate  DateTime?     @db.Date
  recurrenceEndAfter Int?
  customRecurrence   Json?         @db.JsonB
  recurrenceSchedule String?

  // Publishing
  status             ContentStatus @default(DRAFT)
  publishedAt        DateTime?

  // Metadata
  viewCount          Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  createdBy          String?       @db.Uuid
  updatedBy          String?       @db.Uuid
  deletedAt          DateTime?

  // Relations
  church             Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)
  ministry           Ministry?     @relation(fields: [ministryId], references: [id], onDelete: SetNull)
  campus             Campus?       @relation(fields: [campusId], references: [id], onDelete: SetNull)
  eventLinks         EventLink[]

  @@unique([churchId, slug])
  @@index([churchId, dateStart])
  @@index([churchId, type])
  @@index([churchId, ministryId])
  @@index([churchId, campusId])
  @@index([churchId, status])
  @@index([churchId, isFeatured])
  @@index([churchId, isPinned])
  @@index([churchId, isRecurring])
  @@index([churchId, status, dateStart])
  @@index([churchId, type, status, dateStart])
}

enum EventType {
  MEETING
  EVENT
  PROGRAM
}

enum LocationType {
  IN_PERSON
  ONLINE
}

enum Recurrence {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  WEEKDAY
  CUSTOM
}

enum RecurrenceEndType {
  NEVER
  ON_DATE
  AFTER
}

model EventLink {
  id        String  @id @default(uuid()) @db.Uuid
  eventId   String  @db.Uuid
  label     String
  href      String
  external  Boolean @default(false)
  sortOrder Int     @default(0)

  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model BibleStudy {
  id               String        @id @default(uuid()) @db.Uuid
  churchId         String        @db.Uuid
  slug             String
  title            String
  book             BibleBook
  passage          String

  // Dates
  datePosted       DateTime      @db.Date
  dateFor          DateTime      @db.Date

  // Attribution
  seriesId         String?       @db.Uuid
  speakerId        String?       @db.Uuid

  // Content sections
  questions        String?       @db.Text
  answers          String?       @db.Text
  transcript       String?       @db.Text
  bibleText        String?       @db.Text

  // Key verse
  keyVerseRef      String?
  keyVerseText     String?       @db.Text

  // Availability flags
  hasQuestions      Boolean       @default(false)
  hasAnswers        Boolean       @default(false)
  hasTranscript     Boolean       @default(false)

  // Relationship to Message
  relatedMessage   Message?      @relation("MessageStudy")

  // Publishing
  status           ContentStatus @default(DRAFT)
  publishedAt      DateTime?

  // Metadata
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  createdBy        String?       @db.Uuid
  updatedBy        String?       @db.Uuid
  deletedAt        DateTime?

  // Relations
  church           Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)
  series           Series?       @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  speaker          Speaker?      @relation(fields: [speakerId], references: [id], onDelete: SetNull)
  attachments      BibleStudyAttachment[]

  @@unique([churchId, slug])
  @@index([churchId, dateFor(sort: Desc)])
  @@index([churchId, book])
  @@index([churchId, seriesId])
  @@index([churchId, speakerId])
  @@index([churchId, status])
}

enum BibleBook {
  GENESIS
  EXODUS
  LEVITICUS
  NUMBERS
  DEUTERONOMY
  JOSHUA
  JUDGES
  RUTH
  FIRST_SAMUEL
  SECOND_SAMUEL
  FIRST_KINGS
  SECOND_KINGS
  FIRST_CHRONICLES
  SECOND_CHRONICLES
  EZRA
  NEHEMIAH
  ESTHER
  JOB
  PSALMS
  PROVERBS
  ECCLESIASTES
  SONG_OF_SOLOMON
  ISAIAH
  JEREMIAH
  LAMENTATIONS
  EZEKIEL
  DANIEL
  HOSEA
  JOEL
  AMOS
  OBADIAH
  JONAH
  MICAH
  NAHUM
  HABAKKUK
  ZEPHANIAH
  HAGGAI
  ZECHARIAH
  MALACHI
  MATTHEW
  MARK
  LUKE
  JOHN
  ACTS
  ROMANS
  FIRST_CORINTHIANS
  SECOND_CORINTHIANS
  GALATIANS
  EPHESIANS
  PHILIPPIANS
  COLOSSIANS
  FIRST_THESSALONIANS
  SECOND_THESSALONIANS
  FIRST_TIMOTHY
  SECOND_TIMOTHY
  TITUS
  PHILEMON
  HEBREWS
  JAMES
  FIRST_PETER
  SECOND_PETER
  FIRST_JOHN
  SECOND_JOHN
  THIRD_JOHN
  JUDE
  REVELATION
}

model BibleStudyAttachment {
  id           String         @id @default(uuid()) @db.Uuid
  bibleStudyId String         @db.Uuid
  name         String
  url          String
  type         AttachmentType
  fileSize     Int?
  sortOrder    Int            @default(0)

  createdAt    DateTime       @default(now())

  bibleStudy   BibleStudy     @relation(fields: [bibleStudyId], references: [id], onDelete: Cascade)

  @@index([bibleStudyId])
}

enum AttachmentType {
  PDF
  DOCX
  IMAGE
  OTHER
}

model Video {
  id            String        @id @default(uuid()) @db.Uuid
  churchId      String        @db.Uuid
  slug          String
  title         String
  youtubeId     String
  category      VideoCategory
  datePublished DateTime      @db.Date
  duration      String?
  description   String?       @db.Text
  thumbnailUrl  String?
  isShort       Boolean       @default(false)

  // Publishing
  status        ContentStatus @default(DRAFT)
  publishedAt   DateTime?

  // Metadata
  viewCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  createdBy     String?       @db.Uuid
  updatedBy     String?       @db.Uuid
  deletedAt     DateTime?

  church        Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, slug])
  @@index([churchId, datePublished(sort: Desc)])
  @@index([churchId, category])
  @@index([churchId, status])
  @@index([churchId, isShort])
}

enum VideoCategory {
  EVENT_RECAP
  WORSHIP
  TESTIMONY
  SPECIAL_FEATURE
  DAILY_BREAD
  PROMO
  OTHER
}

model DailyBread {
  id          String        @id @default(uuid()) @db.Uuid
  churchId    String        @db.Uuid
  slug        String
  title       String
  date        DateTime      @db.Date
  passage     String
  keyVerse    String?
  body        String        @db.Text
  bibleText   String?       @db.Text
  author      String
  audioUrl    String?

  // Publishing
  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  // Metadata
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String?       @db.Uuid
  updatedBy   String?       @db.Uuid
  deletedAt   DateTime?

  church      Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, slug])
  @@unique([churchId, date])
  @@index([churchId, date(sort: Desc)])
  @@index([churchId, status])
}

model MediaAsset {
  id           String   @id @default(uuid()) @db.Uuid
  churchId     String   @db.Uuid
  filename     String
  url          String
  mimeType     String
  fileSize     Int
  width        Int?
  height       Int?
  alt          String?
  folder       String   @default("/")

  // Auto-generated variants
  thumbnailUrl String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?  @db.Uuid
  deletedAt    DateTime?

  church       Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId, folder])
  @@index([churchId, mimeType])
  @@index([churchId, createdAt(sort: Desc)])
}

model Announcement {
  id          String           @id @default(uuid()) @db.Uuid
  churchId    String           @db.Uuid
  title       String
  body        String?          @db.Text
  priority    AnnouncePriority @default(NORMAL)
  startDate   DateTime         @db.Date
  endDate     DateTime?        @db.Date
  isPinned    Boolean          @default(false)

  status      ContentStatus    @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   String?          @db.Uuid
  deletedAt   DateTime?

  church      Church           @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId, status, startDate])
}

enum AnnouncePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model ContactSubmission {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  formType    String
  name        String
  email       String
  phone       String?
  subject     String?
  message     String?  @db.Text

  // Form-specific fields
  fields      Json?    @db.JsonB

  // Processing
  isRead      Boolean  @default(false)
  readAt      DateTime?
  assignedTo  String?  @db.Uuid
  notes       String?  @db.Text

  createdAt   DateTime @default(now())

  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId, isRead])
  @@index([churchId, formType])
  @@index([churchId, createdAt(sort: Desc)])
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  userId      String?  @db.Uuid
  action      String
  entity      String
  entityId    String?  @db.Uuid
  changes     Json?    @db.JsonB
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId, createdAt(sort: Desc)])
  @@index([churchId, entity, entityId])
  @@index([churchId, userId])
}

// ============================================================
// 4. Website Builder Tables
// ============================================================

model SiteSettings {
  id             String   @id @default(uuid()) @db.Uuid
  churchId       String   @unique @db.Uuid

  // Site identity
  siteName       String
  tagline        String?
  description    String?  @db.Text
  logoUrl        String?
  logoAlt        String?
  faviconUrl     String?
  ogImageUrl     String?

  // Contact info
  contactEmail   String?
  contactPhone   String?
  contactAddress String?  @db.Text

  // Social media URLs
  facebookUrl    String?
  instagramUrl   String?
  youtubeUrl     String?
  twitterUrl     String?
  tiktokUrl      String?
  spotifyUrl     String?
  podcastUrl     String?

  // Service times
  serviceTimes   Json?    @db.JsonB

  // SEO & Analytics
  googleAnalyticsId String?
  metaPixelId       String?

  // Feature flags
  enableBlog           Boolean @default(false)
  enableGiving         Boolean @default(false)
  enableMemberLogin    Boolean @default(false)
  enablePrayerRequests Boolean @default(false)
  enableAnnouncements  Boolean @default(false)
  enableSearch         Boolean @default(true)

  // Custom code injection
  customHeadHtml  String? @db.Text
  customBodyHtml  String? @db.Text

  // Maintenance mode
  maintenanceMode    Boolean @default(false)
  maintenanceMessage String? @db.Text

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  church         Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
}

model Page {
  id              String     @id @default(uuid()) @db.Uuid
  churchId        String     @db.Uuid

  // Identity
  slug            String
  title           String

  // SEO metadata
  metaTitle       String?
  metaDescription String?    @db.Text
  ogImageUrl      String?
  canonicalUrl    String?
  noIndex         Boolean    @default(false)

  // Page settings
  pageType        PageType   @default(STANDARD)
  layout          PageLayout @default(DEFAULT)
  isHomepage      Boolean    @default(false)
  isPublished     Boolean    @default(false)
  publishedAt     DateTime?

  // Ordering
  sortOrder       Int        @default(0)

  // Parent page
  parentId        String?    @db.Uuid
  parent          Page?      @relation("PageHierarchy", fields: [parentId], references: [id])
  children        Page[]     @relation("PageHierarchy")

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  createdBy       String?    @db.Uuid
  updatedBy       String?    @db.Uuid
  deletedAt       DateTime?

  church          Church     @relation(fields: [churchId], references: [id], onDelete: Cascade)
  sections        PageSection[]

  @@unique([churchId, slug])
  @@index([churchId, isPublished])
  @@index([churchId, pageType])
  @@index([churchId, parentId])
  @@index([churchId, isHomepage])
}

enum PageType {
  STANDARD
  LANDING
  MINISTRY
  CAMPUS
  SYSTEM
}

enum PageLayout {
  DEFAULT
  FULL_WIDTH
  NARROW
}

model PageSection {
  id              String         @id @default(uuid()) @db.Uuid
  churchId        String         @db.Uuid
  pageId          String         @db.Uuid

  // Section identity
  sectionType     SectionType
  label           String?

  // Position
  sortOrder       Int            @default(0)

  // Display settings
  visible         Boolean        @default(true)
  colorScheme     ColorScheme    @default(LIGHT)
  paddingY        PaddingSize    @default(DEFAULT)
  containerWidth  ContainerWidth @default(STANDARD)
  enableAnimations Boolean       @default(true)

  // Section-specific content
  content         Json           @db.JsonB

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.Uuid
  updatedBy       String?        @db.Uuid

  page            Page           @relation(fields: [pageId], references: [id], onDelete: Cascade)
  church          Church         @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([pageId, sortOrder])
  @@index([churchId, sectionType])
}

enum SectionType {
  // Hero sections
  HERO_BANNER
  PAGE_HERO
  TEXT_IMAGE_HERO
  EVENTS_HERO
  MINISTRY_HERO

  // Content sections
  MEDIA_TEXT
  MEDIA_GRID
  SPOTLIGHT_MEDIA
  PHOTO_GALLERY
  QUOTE_BANNER
  CTA_BANNER
  ABOUT_DESCRIPTION
  STATEMENT

  // Card layouts
  ACTION_CARD_GRID
  HIGHLIGHT_CARDS
  FEATURE_BREAKDOWN
  PATHWAY_CARD
  PILLARS
  NEWCOMER

  // Lists & data
  ALL_MESSAGES
  ALL_EVENTS
  ALL_BIBLE_STUDIES
  ALL_VIDEOS
  UPCOMING_EVENTS
  EVENT_CALENDAR
  RECURRING_MEETINGS
  RECURRING_SCHEDULE

  // Ministry-specific
  MINISTRY_INTRO
  MINISTRY_SCHEDULE
  CAMPUS_CARD_GRID
  DIRECTORY_LIST
  MEET_TEAM
  LOCATION_DETAIL

  // Interactive
  FORM_SECTION
  FAQ_SECTION
  TIMELINE_SECTION

  // Navigation & layout
  NAVBAR
  FOOTER
  QUICK_LINKS

  // Special
  DAILY_BREAD_FEATURE

  // Generic / custom
  CUSTOM_HTML
  CUSTOM_EMBED
}

enum ColorScheme {
  LIGHT
  DARK
}

enum PaddingSize {
  NONE
  COMPACT
  DEFAULT
  SPACIOUS
}

enum ContainerWidth {
  NARROW
  STANDARD
  FULL
}

model Menu {
  id          String       @id @default(uuid()) @db.Uuid
  churchId    String       @db.Uuid
  name        String
  slug        String
  location    MenuLocation

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  church      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  items       MenuItem[]

  @@unique([churchId, slug])
  @@index([churchId, location])
}

enum MenuLocation {
  HEADER
  FOOTER
  MOBILE
  SIDEBAR
}

model MenuItem {
  id          String   @id @default(uuid()) @db.Uuid
  menuId      String   @db.Uuid

  // Content
  label       String
  href        String?
  description String?
  iconName    String?

  // Behavior
  openInNewTab Boolean @default(false)
  isExternal   Boolean @default(false)

  // Hierarchy
  parentId    String?  @db.Uuid
  parent      MenuItem? @relation("MenuItemTree", fields: [parentId], references: [id])
  children    MenuItem[] @relation("MenuItemTree")

  // Grouping
  groupLabel  String?

  // Featured card in dropdown
  featuredImage       String?
  featuredTitle       String?
  featuredDescription String?
  featuredHref        String?

  // Ordering
  sortOrder   Int      @default(0)

  // Visibility
  isVisible   Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId, parentId, sortOrder])
  @@index([menuId, sortOrder])
}

model Theme {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  slug          String   @unique
  description   String?  @db.Text
  previewUrl    String?
  category      String?
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)

  // Default design tokens
  defaultTokens Json     @db.JsonB

  // Template structure
  defaultPages  Json?    @db.JsonB

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  customizations ThemeCustomization[]
}

model ThemeCustomization {
  id              String   @id @default(uuid()) @db.Uuid
  churchId        String   @unique @db.Uuid
  themeId         String   @db.Uuid

  // Color overrides
  primaryColor    String?
  secondaryColor  String?
  backgroundColor String?
  textColor       String?
  headingColor    String?

  // Typography overrides
  headingFont     String?
  bodyFont        String?
  baseFontSize    Int?

  // Spacing overrides
  borderRadius    String?

  // Component-level overrides
  navbarStyle     Json?    @db.JsonB
  footerStyle     Json?    @db.JsonB
  buttonStyle     Json?    @db.JsonB
  cardStyle       Json?    @db.JsonB

  // Custom CSS
  customCss       String?  @db.Text

  // All overrides as a flat map
  tokenOverrides  Json?    @db.JsonB

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  church          Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  theme           Theme    @relation(fields: [themeId], references: [id])

  @@index([churchId])
  @@index([themeId])
}

// ============================================================
// 5. People & Member Management
// ============================================================

model Person {
  id               String           @id @default(uuid()) @db.Uuid
  churchId         String           @db.Uuid
  slug             String

  // Name
  firstName        String
  lastName         String
  preferredName    String?

  // Demographics
  gender           Gender?
  maritalStatus    MaritalStatus?
  dateOfBirth      DateTime?        @db.Date

  // Contact info
  email            String?
  phone            String?
  mobilePhone      String?
  homePhone        String?

  // Address
  address          Json?            @db.JsonB
  city             String?
  state            String?
  zipCode          String?
  country          String?

  // Profile
  photoUrl         String?
  bio              String?          @db.Text
  title            String?

  // Membership
  membershipStatus MembershipStatus @default(VISITOR)
  membershipDate   DateTime?        @db.Date
  baptismDate      DateTime?        @db.Date
  salvationDate    DateTime?        @db.Date

  // Additional info
  notes            String?          @db.Text
  source           String?

  // Optional link to User for self-service portal
  userId           String?          @db.Uuid

  // Metadata
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  // Relations
  church                  Church                  @relation(fields: [churchId], references: [id], onDelete: Cascade)
  householdMemberships    HouseholdMember[]
  primaryHouseholds       Household[]             @relation("HouseholdPrimaryContact")
  groupMemberships        PersonGroupMember[]
  customFieldValues       CustomFieldValue[]
  personNotes             PersonNote[]
  communicationPreferences CommunicationPreference[]
  personTags              PersonTag[]
  roleAssignments         PersonRoleAssignment[]

  @@unique([churchId, slug])
  @@index([churchId])
  @@index([churchId, membershipStatus])
  @@index([churchId, lastName, firstName])
  @@index([churchId, email])
  @@index([churchId, deletedAt])
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
  OTHER
}

enum MembershipStatus {
  VISITOR
  REGULAR_ATTENDEE
  MEMBER
  INACTIVE
  ARCHIVED
}

model Household {
  id               String   @id @default(uuid()) @db.Uuid
  churchId         String   @db.Uuid
  name             String
  address          Json?    @db.JsonB
  primaryContactId String?  @db.Uuid

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  church           Church           @relation(fields: [churchId], references: [id], onDelete: Cascade)
  primaryContact   Person?          @relation("HouseholdPrimaryContact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  members          HouseholdMember[]

  @@index([churchId])
  @@index([churchId, name])
}

model HouseholdMember {
  id          String        @id @default(uuid()) @db.Uuid
  householdId String        @db.Uuid
  personId    String        @db.Uuid
  role        HouseholdRole @default(OTHER_ADULT)

  createdAt   DateTime      @default(now())

  household   Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  person      Person        @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([householdId, personId])
  @@index([householdId])
  @@index([personId])
}

enum HouseholdRole {
  HEAD
  SPOUSE
  CHILD
  OTHER_ADULT
  DEPENDENT
}

model PersonGroup {
  id              String      @id @default(uuid()) @db.Uuid
  churchId        String      @db.Uuid
  name            String
  slug            String
  description     String?     @db.Text
  groupType       GroupType   @default(SMALL_GROUP)

  // Hierarchy
  parentGroupId   String?     @db.Uuid
  parent          PersonGroup?  @relation("PersonGroupTree", fields: [parentGroupId], references: [id])
  children        PersonGroup[] @relation("PersonGroupTree")

  // Meeting info
  meetingSchedule String?
  meetingLocation String?

  // Settings
  isOpen          Boolean     @default(true)
  capacity        Int?
  photoUrl        String?
  status          GroupStatus @default(ACTIVE)

  // Metadata
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?

  // Relations
  church          Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)
  members         PersonGroupMember[]

  @@unique([churchId, slug])
  @@index([churchId])
  @@index([churchId, groupType])
  @@index([churchId, status])
  @@index([churchId, parentGroupId])
}

enum GroupType {
  SMALL_GROUP
  SERVING_TEAM
  MINISTRY
  CLASS
  ADMINISTRATIVE
  CUSTOM
}

enum GroupStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model PersonGroupMember {
  id        String          @id @default(uuid()) @db.Uuid
  groupId   String          @db.Uuid
  personId  String          @db.Uuid
  role      GroupMemberRole  @default(MEMBER)
  joinedAt  DateTime        @default(now())
  leftAt    DateTime?

  createdAt DateTime        @default(now())

  group     PersonGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  person    Person          @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([groupId, personId])
  @@index([groupId])
  @@index([personId])
}

enum GroupMemberRole {
  LEADER
  CO_LEADER
  MEMBER
}

model CustomFieldDefinition {
  id          String          @id @default(uuid()) @db.Uuid
  churchId    String          @db.Uuid
  name        String
  slug        String
  fieldType   CustomFieldType
  options     Json?           @db.JsonB
  section     String?
  isRequired  Boolean         @default(false)
  isVisible   Boolean         @default(true)
  sortOrder   Int             @default(0)
  permissions Json?           @db.JsonB

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  church      Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)
  values      CustomFieldValue[]

  @@unique([churchId, slug])
  @@index([churchId])
  @@index([churchId, section])
}

enum CustomFieldType {
  TEXT
  DATE
  DROPDOWN
  MULTI_SELECT
  CHECKBOX
  NUMBER
  URL
  FILE
}

model CustomFieldValue {
  id                String              @id @default(uuid()) @db.Uuid
  personId          String              @db.Uuid
  fieldDefinitionId String              @db.Uuid

  value             String

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  person            Person              @relation(fields: [personId], references: [id], onDelete: Cascade)
  fieldDefinition   CustomFieldDefinition @relation(fields: [fieldDefinitionId], references: [id], onDelete: Cascade)

  @@unique([personId, fieldDefinitionId])
  @@index([personId])
  @@index([fieldDefinitionId])
}

model PersonNote {
  id        String   @id @default(uuid()) @db.Uuid
  churchId  String   @db.Uuid
  personId  String   @db.Uuid
  authorId  String   @db.Uuid
  noteType  NoteType @default(GENERAL)
  content   String   @db.Text
  isPinned  Boolean  @default(false)
  isPrivate Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([personId, createdAt(sort: Desc)])
  @@index([personId, noteType])
  @@index([authorId])
}

enum NoteType {
  GENERAL
  PASTORAL
  COUNSELING
  FOLLOW_UP
  PRAYER
}

model CommunicationPreference {
  id        String              @id @default(uuid()) @db.Uuid
  personId  String              @db.Uuid
  channel   CommunicationChannel
  category  String
  isOptedIn Boolean             @default(true)

  updatedAt DateTime            @updatedAt

  person    Person              @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, channel, category])
  @@index([personId])
}

enum CommunicationChannel {
  EMAIL
  SMS
  PHONE
  MAIL
}

model PersonTag {
  id        String   @id @default(uuid()) @db.Uuid
  personId  String   @db.Uuid
  tagName   String

  createdAt DateTime @default(now())

  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, tagName])
  @@index([personId])
  @@index([tagName])
}

model PersonRoleDefinition {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  name        String
  slug        String
  description String?
  isSystem    Boolean  @default(false)
  color       String?
  icon        String?
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  assignments PersonRoleAssignment[]

  @@unique([churchId, slug])
  @@index([churchId])
}

model PersonRoleAssignment {
  id        String    @id @default(uuid()) @db.Uuid
  personId  String    @db.Uuid
  roleId    String    @db.Uuid
  title     String?
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime  @default(now())

  person    Person                @relation(fields: [personId], references: [id], onDelete: Cascade)
  role      PersonRoleDefinition  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([personId, roleId])
  @@index([personId])
  @@index([roleId])
}
